{% extends "base.html" %}

{% block title %}CityGuard AI - Live Dashboard{% endblock %}

{% block content %}
<div class="container my-4">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="display-6 mb-2">
                        <i data-feather="activity" class="me-2"></i>
                        Live Incident Dashboard
                    </h1>
                    <p class="text-muted">Real-time monitoring of local incidents and alerts</p>
                </div>
                <div class="text-end">
                    <button class="btn btn-outline-primary" onclick="refreshDashboard()">
                        <i data-feather="refresh-cw" class="me-1"></i>
                        Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4" id="stats-cards">
        <div class="col-md-3 mb-3">
            <div class="card bg-primary">
                <div class="card-body text-center">
                    <i data-feather="alert-circle" class="mb-2" style="width: 2rem; height: 2rem;"></i>
                    <h4 id="total-incidents" class="mb-1">-</h4>
                    <small>Total Incidents (24h)</small>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card bg-danger">
                <div class="card-body text-center">
                    <i data-feather="alert-triangle" class="mb-2" style="width: 2rem; height: 2rem;"></i>
                    <h4 id="critical-incidents" class="mb-1">-</h4>
                    <small>Critical Alerts</small>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card bg-warning">
                <div class="card-body text-center">
                    <i data-feather="cloud-rain" class="mb-2" style="width: 2rem; height: 2rem;"></i>
                    <h4 id="weather-incidents" class="mb-1">-</h4>
                    <small>Weather Alerts</small>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card bg-info">
                <div class="card-body text-center">
                    <i data-feather="users" class="mb-2" style="width: 2rem; height: 2rem;"></i>
                    <h4 id="active-subscribers" class="mb-1">-</h4>
                    <small>Active Subscribers</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Controls -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-title">
                        <i data-feather="filter" class="me-1"></i>
                        Filter Incidents
                    </h6>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Severity Level</label>
                            <select class="form-select" id="severity-filter" onchange="filterIncidents()">
                                <option value="">All Severities</option>
                                <option value="critical">Critical</option>
                                <option value="high">High</option>
                                <option value="medium">Medium</option>
                                <option value="low">Low</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Source</label>
                            <select class="form-select" id="source-filter" onchange="filterIncidents()">
                                <option value="">All Sources</option>
                                <option value="weather">Weather</option>
                                <option value="news">News</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Time Range</label>
                            <select class="form-select" id="time-filter" onchange="filterIncidents()">
                                <option value="24">Last 24 hours</option>
                                <option value="12">Last 12 hours</option>
                                <option value="6">Last 6 hours</option>
                                <option value="1">Last hour</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Incidents List -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i data-feather="list" class="me-2"></i>
                        Recent Incidents
                    </h5>
                    <span class="badge bg-secondary" id="incident-count">0 incidents</span>
                </div>
                <div class="card-body">
                    <!-- Loading State -->
                    <div id="loading-state" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading incidents...</span>
                        </div>
                        <p class="mt-3 text-muted">Loading latest incidents...</p>
                    </div>

                    <!-- No Incidents State -->
                    <div id="no-incidents-state" class="text-center py-5" style="display: none;">
                        <i data-feather="check-circle" class="mb-3 text-success" style="width: 3rem; height: 3rem;"></i>
                        <h5>No Active Incidents</h5>
                        <p class="text-muted">Great news! No incidents match your current filters.</p>
                    </div>

                    <!-- Error State -->
                    <div id="error-state" class="text-center py-5" style="display: none;">
                        <i data-feather="alert-circle" class="mb-3 text-danger" style="width: 3rem; height: 3rem;"></i>
                        <h5>Unable to Load Incidents</h5>
                        <p class="text-muted">There was an error loading incident data. Please try refreshing the page.</p>
                        <button class="btn btn-primary" onclick="loadIncidents()">
                            <i data-feather="refresh-cw" class="me-1"></i>
                            Try Again
                        </button>
                    </div>

                    <!-- Incidents Container -->
                    <div id="incidents-container">
                        <!-- Incidents will be loaded here via JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Subscribe CTA -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card bg-gradient text-center">
                <div class="card-body">
                    <h5>Stay Informed</h5>
                    <p class="mb-3">Get instant email alerts for critical incidents in your area</p>
                    <a href="{{ url_for('subscribe') }}" class="btn btn-light">
                        <i data-feather="bell" class="me-1"></i>
                        Subscribe to Alerts
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Incident Detail Modal -->
<div class="modal fade" id="incidentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modal-title">Incident Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- Incident details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a id="modal-source-link" href="#" class="btn btn-primary" target="_blank" style="display: none;">
                    <i data-feather="external-link" class="me-1"></i>
                    View Source
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
{% endblock %}
