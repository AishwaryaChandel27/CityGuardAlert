{% extends "base.html" %}

{% block title %}News Alerts - CityGuard AI{% endblock %}

{% block content %}
<div class="container my-4">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="display-6 mb-2">
                        <i data-feather="newspaper" class="me-2"></i>
                        News Alerts
                    </h1>
                    <p class="text-muted">Local news incidents, emergencies, and breaking news</p>
                </div>
                <div class="text-end">
                    <button class="btn btn-outline-primary" onclick="refreshNewsData()">
                        <i data-feather="refresh-cw" class="me-1"></i>
                        Refresh News
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- News Statistics -->
    <div class="row mb-4" id="news-stats">
        <div class="col-md-3 mb-3">
            <div class="card bg-primary">
                <div class="card-body text-center">
                    <i data-feather="file-text" class="mb-2" style="width: 2rem; height: 2rem;"></i>
                    <h4 id="total-news-alerts" class="mb-1">-</h4>
                    <small>Total News Alerts</small>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card bg-danger">
                <div class="card-body text-center">
                    <i data-feather="alert-octagon" class="mb-2" style="width: 2rem; height: 2rem;"></i>
                    <h4 id="emergency-news" class="mb-1">-</h4>
                    <small>Emergency News</small>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card bg-warning">
                <div class="card-body text-center">
                    <i data-feather="navigation" class="mb-2" style="width: 2rem; height: 2rem;"></i>
                    <h4 id="traffic-news" class="mb-1">-</h4>
                    <small>Traffic & Transport</small>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card bg-info">
                <div class="card-body text-center">
                    <i data-feather="shield" class="mb-2" style="width: 2rem; height: 2rem;"></i>
                    <h4 id="crime-news" class="mb-1">-</h4>
                    <small>Crime & Safety</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Controls -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-title">
                        <i data-feather="filter" class="me-1"></i>
                        Filter News Alerts
                    </h6>
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Severity</label>
                            <select class="form-select" id="news-severity-filter" onchange="filterNewsAlerts()">
                                <option value="">All Severities</option>
                                <option value="critical">Critical</option>
                                <option value="high">High</option>
                                <option value="medium">Medium</option>
                                <option value="low">Low</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Category</label>
                            <select class="form-select" id="news-category-filter" onchange="filterNewsAlerts()">
                                <option value="">All Categories</option>
                                <option value="emergency">Emergency</option>
                                <option value="traffic">Traffic</option>
                                <option value="crime">Crime</option>
                                <option value="infrastructure">Infrastructure</option>
                                <option value="health">Health</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Location</label>
                            <input type="text" class="form-control" id="news-location-filter" 
                                   placeholder="Filter by location" onchange="filterNewsAlerts()">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Time Range</label>
                            <select class="form-select" id="news-time-filter" onchange="filterNewsAlerts()">
                                <option value="24">Last 24 hours</option>
                                <option value="12">Last 12 hours</option>
                                <option value="6">Last 6 hours</option>
                                <option value="3">Last 3 hours</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- News Alerts List -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i data-feather="newspaper" class="me-2"></i>
                        Latest News Alerts
                    </h5>
                    <span class="badge bg-secondary" id="news-alert-count">0 alerts</span>
                </div>
                <div class="card-body">
                    <!-- Loading State -->
                    <div id="news-loading-state" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading news alerts...</span>
                        </div>
                        <p class="mt-3 text-muted">Loading latest news data...</p>
                    </div>

                    <!-- No News Alerts State -->
                    <div id="no-news-alerts-state" class="text-center py-5" style="display: none;">
                        <i data-feather="check-circle" class="mb-3 text-success" style="width: 3rem; height: 3rem;"></i>
                        <h5>No News Alerts</h5>
                        <p class="text-muted">No news incidents match your current filters.</p>
                    </div>

                    <!-- News Alerts Container -->
                    <div id="news-alerts-container">
                        <!-- News alerts will be loaded here via JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Breaking News Ticker -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card border-danger">
                <div class="card-header bg-danger text-white">
                    <h6 class="mb-0">
                        <i data-feather="zap" class="me-2"></i>
                        Breaking News & Critical Alerts
                    </h6>
                </div>
                <div class="card-body" id="breaking-news">
                    <div class="text-center py-3">
                        <div class="spinner-border spinner-border-sm text-danger" role="status">
                            <span class="visually-hidden">Loading breaking news...</span>
                        </div>
                        <span class="ms-2">Checking for breaking news...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let allNewsAlerts = [];
let filteredNewsAlerts = [];

document.addEventListener('DOMContentLoaded', function() {
    loadNewsData();
    setInterval(loadNewsData, 3 * 60 * 1000); // Refresh every 3 minutes for news
    feather.replace();
});

async function loadNewsData() {
    try {
        showNewsLoadingState();
        
        // Load news incidents from API
        const timeFilter = document.getElementById('news-time-filter').value || '24';
        const response = await fetch(`/api/incidents/news?hours=${timeFilter}&min_relevance=0.1`);
        const data = await response.json();
        
        if (data.success) {
            allNewsAlerts = data.incidents;
            filterNewsAlerts();
            updateNewsStats(allNewsAlerts);
            loadBreakingNews(allNewsAlerts);
            hideNewsLoadingState();
        } else {
            throw new Error(data.error || 'Failed to load news data');
        }
    } catch (error) {
        console.error('Error loading news data:', error);
        hideNewsLoadingState();
        showNoNewsAlertsState();
    }
}

function filterNewsAlerts() {
    const severityFilter = document.getElementById('news-severity-filter').value;
    const categoryFilter = document.getElementById('news-category-filter').value;
    const locationFilter = document.getElementById('news-location-filter').value.toLowerCase();
    
    filteredNewsAlerts = allNewsAlerts.filter(alert => {
        const matchesSeverity = !severityFilter || alert.severity === severityFilter;
        const matchesCategory = !categoryFilter || alert.category === categoryFilter;
        const matchesLocation = !locationFilter || alert.location.toLowerCase().includes(locationFilter);
        return matchesSeverity && matchesCategory && matchesLocation;
    });
    
    displayNewsAlerts(filteredNewsAlerts);
    updateNewsAlertCount(filteredNewsAlerts.length);
}

function displayNewsAlerts(alerts) {
    const container = document.getElementById('news-alerts-container');
    
    if (alerts.length === 0) {
        showNoNewsAlertsState();
        return;
    }
    
    hideNoNewsAlertsState();
    
    // Sort by relevance score and date
    alerts.sort((a, b) => {
        const scoreA = a.relevance_score || 0;
        const scoreB = b.relevance_score || 0;
        if (scoreB !== scoreA) return scoreB - scoreA;
        return new Date(b.created_at) - new Date(a.created_at);
    });
    
    container.innerHTML = alerts.map(alert => createNewsAlertCard(alert)).join('');
    feather.replace();
}

function createNewsAlertCard(alert) {
    const severityColors = {
        'low': 'success',
        'medium': 'info',
        'high': 'warning',
        'critical': 'danger'
    };
    
    const categoryIcons = {
        'emergency': 'alert-triangle',
        'traffic': 'navigation',
        'crime': 'shield',
        'infrastructure': 'tool',
        'health': 'heart',
        'other': 'file-text'
    };
    
    const severityColor = severityColors[alert.severity] || 'secondary';
    const categoryIcon = categoryIcons[alert.category] || 'file-text';
    const timeAgo = getTimeAgo(alert.created_at);
    const isBreaking = alert.severity === 'critical' || alert.relevance_score > 0.8;
    
    return `
        <div class="card mb-3 news-alert-card border-${severityColor} ${isBreaking ? 'border-2' : ''}">
            <div class="card-body">
                ${isBreaking ? '<div class="badge bg-danger position-absolute top-0 end-0 m-2">BREAKING</div>' : ''}
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div class="d-flex align-items-center">
                        <i data-feather="${categoryIcon}" class="me-2 text-${severityColor}"></i>
                        <span class="badge bg-${severityColor} me-2">${alert.severity.toUpperCase()}</span>
                        <small class="text-muted">${alert.category.toUpperCase()}</small>
                    </div>
                    <small class="text-muted">${timeAgo}</small>
                </div>
                
                <h6 class="card-title">${escapeHtml(alert.title)}</h6>
                
                <p class="card-text text-muted mb-2">
                    ${escapeHtml(alert.ai_summary || alert.description).substring(0, 250)}${(alert.ai_summary || alert.description).length > 250 ? '...' : ''}
                </p>
                
                <div class="d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <i data-feather="map-pin" class="me-1" style="width: 16px; height: 16px;"></i>
                        <small class="text-muted">${escapeHtml(alert.location)}</small>
                        <span class="mx-2">•</span>
                        <small class="text-muted">Relevance: ${Math.round((alert.relevance_score || 0) * 100)}%</small>
                    </div>
                    <div class="d-flex align-items-center">
                        ${alert.url ? `<a href="${alert.url}" target="_blank" class="btn btn-sm btn-outline-secondary me-2">
                            <i data-feather="external-link" class="me-1" style="width: 14px; height: 14px;"></i>
                            Source
                        </a>` : ''}
                        <button class="btn btn-sm btn-outline-primary" onclick="showNewsAlertDetails(${alert.id})">
                            <i data-feather="eye" class="me-1" style="width: 14px; height: 14px;"></i>
                            Details
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function updateNewsStats(alerts) {
    const totalAlerts = alerts.length;
    const emergencyAlerts = alerts.filter(a => a.category === 'emergency' || a.severity === 'critical').length;
    const trafficAlerts = alerts.filter(a => a.category === 'traffic' || a.title.toLowerCase().includes('traffic') || a.title.toLowerCase().includes('road')).length;
    const crimeAlerts = alerts.filter(a => a.category === 'crime' || a.title.toLowerCase().includes('police') || a.title.toLowerCase().includes('crime')).length;
    
    document.getElementById('total-news-alerts').textContent = totalAlerts;
    document.getElementById('emergency-news').textContent = emergencyAlerts;
    document.getElementById('traffic-news').textContent = trafficAlerts;
    document.getElementById('crime-news').textContent = crimeAlerts;
}

function loadBreakingNews(alerts) {
    const breakingNews = alerts.filter(alert => 
        alert.severity === 'critical' || alert.relevance_score > 0.8
    ).slice(0, 3);
    
    const breakingContainer = document.getElementById('breaking-news');
    
    if (breakingNews.length === 0) {
        breakingContainer.innerHTML = `
            <div class="text-center py-2">
                <i data-feather="check-circle" class="me-2 text-success"></i>
                <span class="text-success">No critical news alerts at this time</span>
            </div>
        `;
    } else {
        breakingContainer.innerHTML = breakingNews.map(alert => `
            <div class="d-flex align-items-center mb-2 pb-2 border-bottom">
                <i data-feather="zap" class="me-2 text-danger"></i>
                <div class="flex-grow-1">
                    <strong>${escapeHtml(alert.title)}</strong>
                    <small class="text-muted d-block">${getTimeAgo(alert.created_at)} • ${escapeHtml(alert.location)}</small>
                </div>
                <button class="btn btn-sm btn-outline-danger" onclick="showNewsAlertDetails(${alert.id})">
                    View
                </button>
            </div>
        `).join('');
    }
    
    feather.replace();
}

function refreshNewsData() {
    loadNewsData();
}

function showNewsLoadingState() {
    document.getElementById('news-loading-state').style.display = 'block';
    document.getElementById('no-news-alerts-state').style.display = 'none';
    document.getElementById('news-alerts-container').innerHTML = '';
}

function hideNewsLoadingState() {
    document.getElementById('news-loading-state').style.display = 'none';
}

function showNoNewsAlertsState() {
    document.getElementById('no-news-alerts-state').style.display = 'block';
    document.getElementById('news-alerts-container').innerHTML = '';
}

function hideNoNewsAlertsState() {
    document.getElementById('no-news-alerts-state').style.display = 'none';
}

function updateNewsAlertCount(count) {
    document.getElementById('news-alert-count').textContent = `${count} alert${count !== 1 ? 's' : ''}`;
}

async function showNewsAlertDetails(alertId) {
    try {
        const response = await fetch(`/api/incidents/${alertId}`);
        const data = await response.json();
        
        if (data.success) {
            // Use existing modal from base template or create inline display
            alert(`News Alert Details:\n\n${data.incident.title}\n\n${data.incident.ai_summary || data.incident.description}`);
        }
    } catch (error) {
        console.error('Error loading news alert details:', error);
        alert('Error loading alert details. Please try again.');
    }
}

// Utility functions
function getTimeAgo(dateString) {
    const now = new Date();
    const date = new Date(dateString);
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMins / 60);
    const diffDays = Math.floor(diffHours / 24);
    
    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins} minute${diffMins !== 1 ? 's' : ''} ago`;
    if (diffHours < 24) return `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
    return `${diffDays} day${diffDays !== 1 ? 's' : ''} ago`;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}